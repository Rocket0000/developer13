<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchpedia</title>
    
    <link rel="icon" href="../public/images/favicon.png">
    
    <!-- font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- CSS only Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    
    <!-- JavaScript Bundle with Popper Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>

    <!-- public css -->
    <link rel="stylesheet" href="/public/css/reset.css">
    <link rel="stylesheet" href="/public/css/nav.css">
    <link rel="stylesheet" href="/public/css/footer.css">
    
    <!-- costom css -->
    <link rel="stylesheet" href="order-detail.css">

</head>
<body>
    <!-- Header [시작] -->
    <header>
        <div class="header-wrap">
          <h1 class="logo"><a href="/">로고 이미지</a>
          </h1>
          <ul class="util-link">
            <li><a href="" class="btn btn-link" id="logout">로그아웃</a></li>
            <li><a href="/login" class="btn btn-link" id="login">로그인</a></li>
            <li><a href="/mypage" class="btn btn-link" id="mypage">마이페이지</a></li>
            <li><a href="/register" class="btn btn-link" id="register">회원가입</a></li>
            <li><a href="/cart" class="btn btn-link" id="cart">장바구니</a></li>
          </ul>
        </div>
    </header>
    <!-- Header [끝] -->

    <!-- nav [시작] -->
    <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">스마트워치</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">삼성</a></li>
                            <li><a class="dropdown-item" href="#">애플</a></li>
                            <li><a class="dropdown-item" href="#">샤오미</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">워치스트랩</a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">정품 스트랩</a></li>
                            <li><a class="dropdown-item" href="#">호환 스트랩</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- nav [끝] -->

    <main id="main-container" role="main">
        <div class="main__contents">
            <div class="mypage-head">
                <h1 class="mypage__title">마이 정보</h1>
            </div>

            <div class="mypage-category">
                <ul class="mypage-category nav flex-column">
                    <li class="mypage-category nav-item">
                        <a class="mypage-category--a" aria-current="page" href="/mypage">회원정보 수정</a>
                    </li>
                    <li class="mypage-category nav-item">
                        <a class="mypage-category--a clicked" href="/mypage/orders">주문/배송 조회</a>
                    </li>
                    <li class="mypage-category nav-item">
                        <a class="mypage-category--a user__delete" href="#">회원 탈퇴</a>
                    </li>
                </ul>
            

                <div class="mypage__contents">
                    <div class="subtitle-area">
                        <h2 class="subtitle">상세정보</h2>
                    </div>

                    <!-- 주문 상세 -->
                    <div id="order-detail--wrap">
                        <!-- 주문 수정 모달 -->
                        <div 
                            class="modal" 
                            id="order-edit__modal"
                            tabindex="-1"
                            aria-labelledby="order-edit__modal__label"
                            aria-hidden="true"
                        >
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h2 class="modal-title" id="order-edit__modal--label">주문 수정</h2>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form
                                            action=""
                                            method=""
                                            class="order-edit__modal--info"
                                        >
                                            <table class="table">
                                                <tbody>
                                                    <tr class="input">
                                                        <th scope="row">
                                                            <label for="modal-user__name">받는분</label>
                                                        </th>
                                                        <td>
                                                            <input
                                                                type="text"
                                                                class="modal-user__name form-control"
                                                                id="modal-user__name"
                                                                placeholder="이름을 입력해주세요."
                                                            />
                                                        </td>
                                                    </tr>
                                                    <tr class="input">
                                                        <th scope="row">
                                                            <label for="modal-user__phonenumber">연락처</label>
                                                        </th>
                                                        <td>
                                                            <input
                                                                type="text"
                                                                class="modal-user__phonenumber form-control"
                                                                id="modal-user__phonenumber"
                                                                placeholder="- 제외 입력해주세요"
                                                                maxlength="11"
                                                            />
                                                        </td>
                                                    </tr>
                                                    <tr class="input">
                                                        <th scope="row">
                                                            <label for="modal-user__addr">배송지</label>
                                                        </th>
                                                        <td class="modal-address--group">
                                                            <div class="modal-address__input">
                                                                <input
                                                                    type="text"
                                                                    class="modal-user__postcode form-control"
                                                                    id="modal-user__postcode"
                                                                    readonly
                                                                />
                                                                <button type="button" class="modal-address__search btn btn-light" onclick="searchAddress()">
                                                                    주소검색
                                                                </button>
                                                            </div>
                                                            <input
                                                                type="text"
                                                                class="modal-address__input--first form-control"
                                                                id="modal-address__input--first"
                                                                readonly
                                                            />
                                                            <input
                                                                type="text"
                                                                class="modal-address__input--second form-control"
                                                                id="modal-address__input--second"
                                                                maxlength="30"
                                                                placeholder="상세주소를 입력해주세요."
                                                            />
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                                        <button type="button" class="btn btn-primary" onclick="orderEditModal()">확인</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- <script type="module" src="order-edit-modal.js" defer></script> -->
    
    <!-- Footer [시작] -->
    <footer>
        <address>&copy; 엘리스 SW 4기 : 13팀 - 시계는 와!!치!!</address>
    </footer>
    <!-- Footer [끝] -->
    
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script type="text/javascript" src="/public/js/nav.js" defer ></script>
    <script type="module" src="order-detail.js" defer></script>
    <script>
        const orderEditModal = () => {
            const orderObjId = window.location.href.split('/')

            const receiverName = document.getElementById("modal-user__name").value;
            const receiverPhone = document.getElementById("modal-user__phonenumber").value;
            const zipCode = document.getElementById("modal-user__postcode").value;
            const extraAddress = document.getElementById("modal-address__input--first").value;
            const extraAddress_2 = document.getElementById("modal-address__input--second").value;
            
            const changeData = { receiverName, receiverPhone, zipCode, extraAddress, extraAddress_2}

            console.log('확인', JSON.stringify(changeData), orderObjId)
            fetch(`/api/mypage/order/${orderObjId[5]}`,{
                method: 'PATCH',
                headers:{
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${sessionStorage.getItem("token")}`
                },
                body: JSON.stringify(changeData)
            })
            .then((res) => {
                if(res.ok){
                    alert("배송 정보가 변경되었습니다.");
                    location.replace(location.href)
                    return res
                }
                return res.json()
            })
            .catch((err) => {
                console.error('err:::', err)
            })
        }

        function searchAddress(e) {
            // e.preventDefault();

            new daum.Postcode({
                oncomplete: function (data) {
                    let addr = "";
                    let extraAddr = "";
                
                    if (data.userSelectedType === "R") {
                        addr = data.roadAddress;
                    } else {
                        addr = data.jibunAddress;
                    }
                
                    if (data.userSelectedType === "R") {
                        if (data.bname !== "" && /[동|로|가]$/g.test(data.bname)) {
                            extraAddr += data.bname;
                        }
                        if (data.buildingName !== "" && data.apartment === "Y") {
                            extraAddr +=
                            extraAddr !== "" ? ", " + data.buildingName : data.buildingName;
                        }
                        if (extraAddr !== "") {
                            extraAddr = " (" + extraAddr + ")";
                        }
                    } else {
                    }
                
                    const shippingPostCode = document.getElementById(
                        "modal-user__postcode"
                    );
                    const shippingStreetAddress = document.getElementById(
                        "modal-address__input--first"
                    );
                    const shippingExtraAddress = document.getElementById(
                        "modal-address__input--second"
                    );
                    shippingPostCode.value = `${data.zonecode}`;
                    shippingStreetAddress.value = `${addr} ${extraAddr}`;
                    shippingExtraAddress.focus();
                },
            }).open();
}

    </script>
</body>
</html>